open Graphjs_base
open Graphjs_share
open Graphjs_mdg

type t =
  { kind : string
  ; sink : string
  ; file : string
  ; line : int
  }

let create (kind : string) (sink : string) (file : string) (line : int) : t =
  { kind; sink; file; line }

let of_sink (node : Node.t) : t =
  match node.kind with
  | TaintSink sink ->
    let name = Tainted.(name !sink) in
    let kind = Sink_kind.str (Tainted.kind sink) in
    create kind name node.at.file node.at.lpos.line
  | _ -> Log.fail "unexpected non taint-sink node"

let pp_vuln (ppf : Fmt.t) (vuln : t) : unit =
  Fmt.fmt ppf "\"vuln_type\": %S@\n" vuln.kind;
  Fmt.fmt ppf "\"file\": %S@\n" vuln.file;
  Fmt.fmt ppf "\"sink\": %S@\n" vuln.sink;
  Fmt.fmt ppf "\"sink_lineno\": %d@\n" vuln.line

let pp (ppf : Fmt.t) (vuln : t) : unit =
  Fmt.pp_str ppf "{@\n@[<v 2>  ";
  Fmt.fmt ppf "\"vuln_type\": %S@\n" vuln.kind;
  Fmt.fmt ppf "\"file\": %S@\n" vuln.file;
  Fmt.fmt ppf "\"sink\": %S@\n" vuln.sink;
  Fmt.fmt ppf "\"sink_lineno\": %d@\n" vuln.line;
  Fmt.pp_str ppf "@]}"

let str (vuln : t) : string = Fmt.str "%a" pp vuln [@@inline]
