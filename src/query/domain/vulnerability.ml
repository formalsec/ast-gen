open Graphjs_base
open Graphjs_share
open Graphjs_mdg

type t =
  { kind : string
  ; sink : string
  ; line : int
  }

let create (kind : string) (sink : string) (line : int) : t =
  { kind; sink; line }

let of_node (sink : Tainted.sink) (node : Node.t) : t =
  let kind = Sink_kind.str sink.kind in
  create kind sink.name node.at.lpos.line

let pp (ppf : Fmt.t) (vuln : t) : unit =
  Fmt.fmt ppf "{@\n@[<v 2>  ";
  Fmt.fmt ppf "\"vuln_type\": %S" vuln.kind;
  Fmt.fmt ppf "@\n\"sink\": %S" vuln.sink;
  Fmt.fmt ppf "@\n\"sink_lineno\": %d@]" vuln.line;
  Fmt.fmt ppf "@\n}"

let str (vuln : t) : string = Fmt.str "%a" pp vuln

let pp_result (path : Fpath.t) (ppf : Fmt.t) (vulns : t list) : unit =
  if List.length vulns > 0 then Fmt.(pp_lst !>"@\n" pp) ppf vulns
  else Fmt.fmt ppf "No vulnerabilities detected in \"%a\"." Fpath.pp path
